{% extends "base.html" %}

{% block page_title %}Détails Trésorerie{% endblock %}
{% block page_subtitle %}{{ chantier.nom }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <a href="{{ url_for('finance.index') }}" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 transition-colors mb-4">
        <i class="fas fa-arrow-left"></i> Retour
    </a>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500 font-medium uppercase">Budget</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">{{ format_currency(budget) }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500 font-medium uppercase">Dépenses Totales</p>
            <p class="text-2xl font-bold text-red-600 mt-2">{{ format_currency(total_general) }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500 font-medium uppercase">Reste</p>
            <p class="text-2xl font-bold {% if reste < 0 %}text-red-600{% else %}text-green-600{% endif %} mt-2">{{ format_currency(reste) }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500 font-medium uppercase">Consommation</p>
            <div class="mt-2 flex items-center gap-3">
                <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-primary-600 rounded-full" style="width: {{ consommation_pct|round }}%"></div>
                </div>
                <span class="text-sm font-bold text-gray-700">{{ consommation_pct|round }}%</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Expenses by Category (Chart & List) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Répartition des Dépenses</h3>
            <div class="h-64 relative">
                <canvas id="expensesChart"></canvas>
            </div>
            <div class="mt-6 space-y-3">
                {% for cat, amount in achats_by_category.items() %}
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium text-gray-700 capitalize">{{ cat }}</span>
                    <span class="font-bold text-gray-900">{{ format_currency(amount) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Labor vs Material -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Main d'œuvre vs Matériel</h3>
             <div class="h-64 relative">
                <canvas id="laborChart"></canvas>
            </div>
            <div class="mt-6 space-y-3">
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <span class="font-medium text-blue-800">Achats / Matériel</span>
                    <span class="font-bold text-blue-900">{{ format_currency(total_depenses) }}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg border border-orange-100">
                    <span class="font-medium text-orange-800">Main d'œuvre</span>
                    <span class="font-bold text-orange-900">{{ format_currency(total_main_oeuvre) }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Lists -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="border-b border-gray-100 bg-gray-50 px-6 py-4 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Détail des Achats</h3>
            <a href="{{ url_for('finance.export_achats', chantier_id=chantier.id) }}" class="text-sm text-primary-600 font-medium hover:text-primary-700 flex items-center gap-1">
                <i class="fas fa-file-export"></i> Exporter
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold">
                    <tr>
                        <th class="px-6 py-3">Date</th>
                        <th class="px-6 py-3">Fournisseur</th>
                        <th class="px-6 py-3">Catégorie</th>
                        <th class="px-6 py-3">Description</th>
                        <th class="px-6 py-3 text-right">Montant</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for achat in achats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm text-gray-600">{{ achat.date_achat.strftime('%d/%m/%Y') }}</td>
                        <td class="px-6 py-3 font-medium text-gray-900">{{ achat.fournisseur }}</td>
                        <td class="px-6 py-3 text-sm"><span class="px-2 py-1 bg-gray-100 rounded text-gray-600 text-xs capitalize">{{ achat.categorie }}</span></td>
                        <td class="px-6 py-3 text-sm text-gray-500 truncate max-w-xs">{{ achat.description }}</td>
                        <td class="px-6 py-3 text-right font-medium text-gray-900">{{ format_currency(achat.montant) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const ctxExpenses = document.getElementById('expensesChart').getContext('2d');
    const categories = {{ achats_by_category.keys()|list|tojson }};
    const amounts = {{ achats_by_category.values()|list|tojson }};

    new Chart(ctxExpenses, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: amounts,
                backgroundColor: [
                    '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });

    const ctxLabor = document.getElementById('laborChart').getContext('2d');
    new Chart(ctxLabor, {
        type: 'bar',
        data: {
            labels: ['Achats', 'Main d\'œuvre'],
            datasets: [{
                label: 'Dépenses',
                data: [{{ total_depenses }}, {{ total_main_oeuvre }}],
                backgroundColor: ['#3b82f6', '#f97316']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}
