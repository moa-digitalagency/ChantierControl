{% extends "base.html" %}

{% block title %}Détails Trésorerie{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('finance.index') }}" class="p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight">{{ chantier.nom }}</h1>
                <p class="text-gray-500 text-sm mt-1">Détails financiers et analyse des coûts.</p>
            </div>
        </div>
        <div>
             <a href="{{ url_for('finance.export_achats', chantier_id=chantier.id) }}" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm transition-colors">
                <i class="fas fa-file-excel text-green-600"></i>
                <span>Exporter Achats</span>
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Budget -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Budget Alloué</p>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-2xl font-bold text-gray-900">{{ format_currency(budget) }}</span>
            </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-1.5">
                <div class="bg-blue-500 h-1.5 rounded-full" style="width: 100%"></div>
            </div>
        </div>

        <!-- Total Spent -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Dépensé</p>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-2xl font-bold text-gray-900">{{ format_currency(total_general) }}</span>
            </div>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-1.5">
                <div class="{% if consommation_pct > 100 %}bg-red-500{% elif consommation_pct > 80 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-1.5 rounded-full" style="width: {{ [consommation_pct, 100]|min }}%"></div>
            </div>
            <p class="mt-2 text-xs text-gray-500">{{ consommation_pct|round(1) }}% du budget</p>
        </div>

        <!-- Reste -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Reste à Dépenser</p>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-2xl font-bold {% if reste < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    {{ format_currency(reste) }}
                </span>
            </div>
             <p class="mt-2 text-xs text-gray-500">Marge restante</p>
        </div>

        <!-- Main d'oeuvre part -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Part Main d'Oeuvre</p>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-2xl font-bold text-orange-600">
                    {{ format_currency(total_main_oeuvre) }}
                </span>
            </div>
            <p class="mt-2 text-xs text-gray-500">
                {% if total_general > 0 %}
                {{ (total_main_oeuvre / total_general * 100)|round(1) }}% des dépenses
                {% else %}
                0% des dépenses
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Expenses Breakdown -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-900 mb-6">Répartition par Catégorie</h3>
            <div class="relative h-64 w-full">
                <canvas id="expensesChart"></canvas>
            </div>
        </div>

        <!-- Expense List Summary -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Top Dépenses</h3>
            <div class="flex-1 overflow-y-auto pr-2 space-y-4">
                {% for cat, amount in achats_by_category.items() %}
                <div class="flex justify-between items-center p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-primary-500"></div>
                        <span class="text-sm font-medium text-gray-700 capitalize">{{ cat }}</span>
                    </div>
                    <span class="text-sm font-bold text-gray-900">{{ format_currency(amount) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Detailed Transactions Tabs -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" x-data="{ tab: 'achats' }">
        <!-- Tab Headers -->
        <div class="border-b border-gray-200 bg-gray-50 flex">
            <button @click="tab = 'achats'" :class="{'bg-white border-b-2 border-primary-500 text-primary-700': tab === 'achats', 'text-gray-500 hover:text-gray-700': tab !== 'achats'}" class="px-6 py-4 font-medium text-sm focus:outline-none transition-colors">
                Achats & Matériaux
            </button>
            <button @click="tab = 'mo'" :class="{'bg-white border-b-2 border-primary-500 text-primary-700': tab === 'mo', 'text-gray-500 hover:text-gray-700': tab !== 'mo'}" class="px-6 py-4 font-medium text-sm focus:outline-none transition-colors">
                Main d'Oeuvre
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="p-0">
            <!-- Achats Tab -->
            <div x-show="tab === 'achats'" class="overflow-x-auto">
                <table class="responsive-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Fournisseur</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Catégorie</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Montant</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for achat in achats %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-label="Date">{{ achat.date_achat.strftime('%d/%m/%Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Fournisseur">{{ achat.fournisseur }}</td>
                            <td class="px-6 py-4 whitespace-nowrap" data-label="Catégorie">
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 capitalize">
                                    {{ achat.categorie }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="{{ achat.description }}" data-label="Description">{{ achat.description }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900" data-label="Montant">{{ format_currency(achat.montant) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">Aucun achat enregistré.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- MO Tab -->
            <div x-show="tab === 'mo'" class="overflow-x-auto" style="display: none;">
                <table class="responsive-table min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ouvrier</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Heures</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Montant</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for p in pointages %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" data-label="Date">{{ p.date_pointage.strftime('%d/%m/%Y') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Ouvrier">{{ p.ouvrier.nom }} {{ p.ouvrier.prenom }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600" data-label="Heures">{{ p.heures }} h</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900" data-label="Montant">{{ format_currency(p.montant) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-gray-500">Aucun pointage enregistré.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Alpine.js for Tabs (Lightweight dependency, usually good to include if not present, or use vanilla JS) -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('expensesChart').getContext('2d');
        const categories = {{ achats_by_category.keys()|list|tojson }};
        const amounts = {{ achats_by_category.values()|list|tojson }};

        // Colors palette
        const colors = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316'
        ];

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Montant (MAD)',
                    data: amounts,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}
