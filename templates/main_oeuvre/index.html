{% extends "base.html" %}

{% block page_title %}Ouvriers{% endblock %}
{% block page_subtitle %}Gestion des effectifs et affectations{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Actions -->
    <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
        <!-- Search & Filter -->
        <div class="flex flex-col md:flex-row gap-4 w-full xl:w-auto flex-1 max-w-4xl">
             <div class="relative w-full md:w-96 group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-primary-500 transition-colors">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" id="workerSearch" placeholder="Rechercher par nom, poste..." class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent sm:text-sm transition-all shadow-sm hover:shadow-md h-11">
            </div>

            <form method="GET" action="{{ url_for('main_oeuvre.index') }}" class="w-full md:w-auto">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-primary-500 transition-colors">
                        <i class="fas fa-filter"></i>
                    </div>
                    <select id="chantier_select" name="chantier_id" onchange="this.form.submit()" class="block w-full md:w-64 pl-10 pr-10 py-2.5 text-base border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent sm:text-sm rounded-xl bg-white shadow-sm hover:shadow-md transition-all appearance-none cursor-pointer h-11 text-gray-700">
                        <option value="">Tous les chantiers</option>
                        {% for c in chantiers %}
                        <option value="{{ c.id }}" {% if selected_chantier_id == c.id %}selected{% endif %}>{{ c.nom }}</option>
                        {% endfor %}
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </form>
        </div>

        <!-- Buttons -->
        <div class="flex flex-wrap gap-3 w-full xl:w-auto justify-end">
            <a href="{{ url_for('main_oeuvre.pointage') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-50 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm transition-all h-11">
                <i class="fas fa-clock text-gray-400 group-hover:text-primary-500"></i>
                <span>Pointage</span>
            </a>

            <div class="flex gap-2">
                 <a href="{{ url_for('main_oeuvre.export') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-50 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm transition-all h-11" title="Exporter Excel">
                    <i class="fas fa-file-export text-gray-400"></i>
                    <span class="hidden sm:inline">Exporter</span>
                </a>

                {% if session.get('user_role') in ['admin', 'direction', 'super_admin'] %}
                <button onclick="document.getElementById('import-modal').classList.remove('hidden')" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-50 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm transition-all h-11" title="Importer Excel">
                    <i class="fas fa-file-import text-gray-400"></i>
                    <span class="hidden sm:inline">Importer</span>
                </button>
                {% endif %}
            </div>

            {% if session.get('user_role') in ['admin', 'direction', 'super_admin', 'chef_chantier'] %}
            <a href="{{ url_for('main_oeuvre.nouveau') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-xl shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-primary-500/30 hover:shadow-primary-500/40 h-11">
                <i class="fas fa-plus"></i>
                <span>Ajouter</span>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Workers List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="responsive-table min-w-full divide-y divide-gray-100">
                <thead class="bg-gray-50/50">
                    <tr>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ouvrier</th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Chantier Actuel</th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Coordonnées</th>
                        <th scope="col" class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Taux Horaire</th>
                        <th scope="col" class="relative px-6 py-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-50">
                    {% for ouvrier in ouvriers %}
                    <tr class="hover:bg-gray-50/80 transition-colors group">
                        <td class="px-6 py-4 whitespace-nowrap" data-label="Ouvrier">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 relative">
                                    {% if ouvrier.photo_profil %}
                                    <img class="h-10 w-10 rounded-full object-cover border border-gray-200 shadow-sm" src="{{ url_for('static', filename='uploads/' + ouvrier.photo_profil) }}" alt="">
                                    {% else %}
                                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-400 shadow-inner border border-gray-100">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    {% endif %}
                                    <!-- Online indicator (optional logic) -->
                                    <span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-green-400"></span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900 worker-name">{{ ouvrier.nom }} {{ ouvrier.prenom }}</div>
                                    <div class="text-xs text-gray-500 worker-poste flex items-center gap-1">
                                        {{ ouvrier.poste or 'Poste non défini' }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap" data-label="Chantier Actuel">
                            {% if ouvrier.chantier %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                                    <i class="fas fa-hard-hat mr-1.5 mt-0.5 opacity-70"></i> {{ ouvrier.chantier.nom }}
                                </span>
                            {% else %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-600 border border-gray-200">
                                    Non assigné
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap" data-label="Coordonnées">
                            <div class="text-sm text-gray-700 flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                                    <i class="fas fa-phone-alt text-xs"></i>
                                </div>
                                {{ ouvrier.telephone or '-' }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1 pl-8">
                                {% if ouvrier.ville %}{{ ouvrier.ville }}{% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right" data-label="Taux Horaire">
                            <span class="text-sm font-bold text-gray-900">{{ "{:,.2f}".format(ouvrier.taux_horaire) }}</span>
                            <span class="text-xs text-gray-500 font-medium">MAD/h</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center" data-label="Actions">
                            <div class="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-all transform translate-y-1 group-hover:translate-y-0">
                                <a href="{{ url_for('main_oeuvre.details', id=ouvrier.id) }}" class="text-gray-500 hover:text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors tooltip" data-tip="Voir Fiche">
                                    <i class="fas fa-eye text-lg"></i>
                                </a>

                                {% if session.get('user_role') in ['admin', 'direction', 'super_admin', 'chef_chantier'] %}
                                <a href="{{ url_for('main_oeuvre.modifier', id=ouvrier.id) }}" class="text-gray-500 hover:text-primary-600 hover:bg-primary-50 p-2 rounded-lg transition-colors tooltip" data-tip="Modifier">
                                    <i class="fas fa-pen text-lg"></i>
                                </a>
                                {% endif %}

                                {% if session.get('user_role') in ['admin', 'direction', 'super_admin'] %}
                                <form action="{{ url_for('main_oeuvre.supprimer', id=ouvrier.id) }}" method="POST" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet ouvrier ?');" class="inline-block">
                                    <button type="submit" class="text-gray-500 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors tooltip" data-tip="Supprimer">
                                        <i class="fas fa-trash-alt text-lg"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if not ouvriers %}
        <div class="p-12 text-center bg-gray-50/50 border-t border-gray-100">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white shadow-sm mb-4">
                <i class="fas fa-hard-hat text-gray-300 text-3xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">Aucun ouvrier trouvé</h3>
            <p class="mt-1 text-gray-500 max-w-sm mx-auto">
                {% if selected_chantier_id %}
                Aucun ouvrier assigné à ce chantier pour le moment.
                {% else %}
                Votre base de données d'ouvriers est vide. Commencez par en ajouter.
                {% endif %}
            </p>
            {% if session.get('user_role') in ['admin', 'direction', 'super_admin', 'chef_chantier'] %}
            <div class="mt-6">
                <a href="{{ url_for('main_oeuvre.nouveau') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg shadow-sm transition-colors">
                    <i class="fas fa-plus"></i> Ajouter un ouvrier
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="fixed inset-0 bg-gray-900/50 z-50 hidden backdrop-blur-sm transition-opacity opacity-0" aria-labelledby="modal-title" role="dialog" aria-modal="true" style="transition: opacity 0.2s ease-in-out;">
    <div class="flex items-center justify-center min-h-screen p-4 text-center sm:p-0">
        <div class="relative bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-lg w-full scale-95" id="import-modal-panel" style="transition: transform 0.2s ease-in-out;">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-50 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-file-import text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">Importer des Ouvriers</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 mb-6">
                                Importez une liste d'ouvriers depuis un fichier Excel (.xlsx). Téléchargez le modèle pour voir le format attendu.
                            </p>

                            <a href="{{ url_for('main_oeuvre.download_template') }}" class="group flex items-center justify-between p-4 mb-6 rounded-xl border border-gray-200 hover:border-primary-200 hover:bg-primary-50 transition-colors cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center">
                                        <i class="fas fa-file-excel text-xl"></i>
                                    </div>
                                    <div class="text-left">
                                        <p class="font-medium text-gray-900 group-hover:text-primary-700">Modèle d'import</p>
                                        <p class="text-xs text-gray-500">Télécharger le fichier vierge</p>
                                    </div>
                                </div>
                                <i class="fas fa-download text-gray-400 group-hover:text-primary-500"></i>
                            </a>

                            <form action="{{ url_for('main_oeuvre.import_ouvriers') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
                                <div class="relative group">
                                    <div class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 group-hover:bg-white group-hover:border-primary-400 transition-all">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                            <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2 group-hover:text-primary-500 transition-colors"></i>
                                            <p class="mb-1 text-sm text-gray-500"><span class="font-semibold text-primary-600">Cliquez pour upload</span> ou glissez le fichier</p>
                                            <p class="text-xs text-gray-400" id="file-name-display">XLSX, XLS jusqu'à 10MB</p>
                                        </div>
                                        <input id="file-upload" name="file" type="file" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required onchange="document.getElementById('file-name-display').innerText = this.files[0].name; document.getElementById('file-name-display').classList.add('text-gray-900', 'font-medium');">
                                    </div>
                                </div>

                                <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-100">
                                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200 sm:text-sm shadow-sm">Annuler</button>
                                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:text-sm shadow-sm shadow-primary-500/30">Importer</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Search Functionality
    document.getElementById('workerSearch').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            let name = row.querySelector('.worker-name').textContent.toLowerCase();
            let poste = row.querySelector('.worker-poste').textContent.toLowerCase();
            if (name.includes(filter) || poste.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Modal Logic
    const modal = document.getElementById('import-modal');
    const modalPanel = document.getElementById('import-modal-panel');

    function openModal() {
        modal.classList.remove('hidden');
        // Small timeout to allow display:block to apply before opacity transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalPanel.classList.remove('scale-95');
            modalPanel.classList.add('scale-100');
        }, 10);
    }

    function closeModal() {
        modal.classList.add('opacity-0');
        modalPanel.classList.remove('scale-100');
        modalPanel.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }

    // Wire up trigger
    document.querySelector('button[onclick*="import-modal"]').onclick = openModal;
</script>
{% endblock %}
