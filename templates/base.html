<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/favicon.svg') }}">
    <title>{% block title %}Gestion Chantiers{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar-link.active {
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
            border-right: 4px solid #1d4ed8;
        }
        /* Role specific overrides if needed, but blue is a safe default for users */
        {% if session.get('user_role') == 'super_admin' %}
        .sidebar-link.active {
            background-color: #f5f3ff; /* purple-50 */
            color: #6d28d9; /* purple-700 */
            border-right-color: #6d28d9;
        }
        {% elif session.get('user_role') == 'admin' %}
        .sidebar-link.active {
            background-color: #eef2ff; /* indigo-50 */
            color: #4338ca; /* indigo-700 */
            border-right-color: #4338ca;
        }
        {% endif %}
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col h-full">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-center h-16 border-b border-gray-200 px-6 bg-white">
                <a href="{{ url_for('dashboard.index') }}" class="flex items-center gap-2 text-xl font-bold text-gray-800 hover:text-blue-600 transition-colors">
                    <i class="fas fa-hard-hat text-blue-600"></i>
                    <span>Gestion Chantiers</span>
                </a>
            </div>

            <!-- Navigation Links -->
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                {% if session.get('user_id') %}
                    {% set role = session.get('user_role') %}

                    {% if role == 'super_admin' %}
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Administration</p>
                        <a href="{{ url_for('superadmin.index') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if request.endpoint == 'superadmin.index' %}active{% endif %}">
                            <i class="fas fa-tachometer-alt w-5 text-center"></i>
                            <span class="font-medium">Dashboard</span>
                        </a>
                        <a href="{{ url_for('superadmin.liste_entreprises') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if 'entreprise' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-building w-5 text-center"></i>
                            <span class="font-medium">Entreprises</span>
                        </a>
                        <a href="{{ url_for('superadmin.parametres') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if request.endpoint == 'superadmin.parametres' %}active{% endif %}">
                            <i class="fas fa-cog w-5 text-center"></i>
                            <span class="font-medium">Paramètres</span>
                        </a>

                    {% elif role == 'admin' %}
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Gestion</p>
                        <a href="{{ url_for('admin.index') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if request.endpoint == 'admin.index' %}active{% endif %}">
                            <i class="fas fa-users-cog w-5 text-center"></i>
                            <span class="font-medium">Gestion</span>
                        </a>
                        <a href="{{ url_for('chantiers.liste') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if 'chantiers' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-building w-5 text-center"></i>
                            <span class="font-medium">Chantiers</span>
                        </a>
                        <a href="{{ url_for('validation.liste') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if 'validation' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-check-circle w-5 text-center"></i>
                            <span class="font-medium">Validations</span>
                        </a>

                    {% else %}
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Menu Principal</p>
                        <a href="{{ url_for('dashboard.index') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if request.endpoint == 'dashboard.index' %}active{% endif %}">
                            <i class="fas fa-tachometer-alt w-5 text-center"></i>
                            <span class="font-medium">Tableau de bord</span>
                        </a>
                        <a href="{{ url_for('chantiers.liste') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if 'chantiers' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-building w-5 text-center"></i>
                            <span class="font-medium">Chantiers</span>
                        </a>
                        {% if role == 'direction' %}
                        <a href="{{ url_for('validation.liste') }}" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors {% if 'validation' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-check-circle w-5 text-center"></i>
                            <span class="font-medium">Validations</span>
                        </a>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </nav>

            <!-- User Profile & Logout -->
            {% if session.get('user_id') %}
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg">
                        {{ session.get('user_nom', 'U')[0] }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">{{ session.get('user_nom') }}</p>
                        <p class="text-xs text-gray-500 truncate capitalize">{{ session.get('user_role', 'Utilisateur')|replace('_', ' ') }}</p>
                    </div>
                    <a href="{{ url_for('auth.logout') }}" class="p-2 text-gray-400 hover:text-red-600 transition-colors" title="Déconnexion">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- Mobile Overlay -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
            
            <!-- Mobile Header -->
            <header class="bg-white shadow-sm md:hidden flex items-center justify-between px-4 h-16 z-30">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <span class="font-bold text-gray-800 text-lg">Gestion Chantiers</span>
                </div>
                <!-- Optional: User avatar or notification icon on mobile right -->
            </header>

            <!-- Main Scrollable Area -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                <div class="max-w-7xl mx-auto">
                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    <div class="mb-6 space-y-3">
                        {% for category, message in messages %}
                        <div class="flex items-center p-4 rounded-lg shadow-sm border-l-4 {% if category == 'success' %}bg-green-50 text-green-800 border-green-500{% elif category == 'danger' %}bg-red-50 text-red-800 border-red-500{% elif category == 'warning' %}bg-yellow-50 text-yellow-800 border-yellow-500{% else %}bg-blue-50 text-blue-800 border-blue-500{% endif %}">
                            <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'danger' %}fa-exclamation-circle{% elif category == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-3 text-lg"></i>
                            <span class="font-medium">{{ message }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- Page Content -->
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/offline_sync.js') }}"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                // Open sidebar
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close sidebar
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // Close sidebar when clicking a link on mobile
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}")
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
